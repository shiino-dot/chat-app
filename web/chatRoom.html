<!DOCTYPE html>
<html lang="js">
<head>
    <meta charset="UTF-8">
    <title>chatroom</title>
</head>
<body>
    <h1 id="chat-title">welcome to </h1>
    <p id='online-user'>現在の参加数：</p>
    <p id="roomDiscription">部屋の説明：</p>
    <div>
        <div id="post-content-lists"></div>    
    </div>
        <input type="text" id="new-post-content"><button id="new-post-content-submit">送信</button>

    <div>
        <button id="delete-user">退会する</button>
    </div>

    <script>
        //titleの取得
        async function fetchChatRoomInfo() {
            return fetch(`../rooms/index`)
                .then((response) => response.json())
                .then((chatRoomIndex) => {
                    getChatRoomInfo(chatRoomIndex)
                })
                .then(console.log('200 OK! chatroom conected!!'))
        }

        function getChatRoomInfo(chatRoomIndex) {
            const titleContainer = document.querySelector('#chat-title');
            const discriptionContainer = document.querySelector('#roomDiscription');

            const title_label = document.createElement('label');
            const title = new Text(chatRoomIndex[0].title);
            const discription_label = document.createElement('label');
            const discription = new Text(chatRoomIndex[0].discription);

            title_label.appendChild(title);
            discription_label.appendChild(discription);

            titleContainer.appendChild(title_label);
            discriptionContainer.appendChild(discription_label);
        }

        //chatContentの表示
        function renderChatContent(chatRoomContent) {
            const chatContainer = document.querySelector('#post-content-lists');

            chatContainer.innerHTML = '';

            //投稿内容のjsonの取り出し
            for(const message of chatRoomContent) {
                const p = document.createElement('p');
                const label = document.createElement('label');
                const text = new Text(message.content);

                label.appendChild(text);
                p.appendChild(label);
                chatContainer.appendChild(p);
            }

        }

        //chatRoomContentの取得
        async function fetchChatContent() {
            return fetch(`../rooms/1/info`)
                .then((response) => response.json())
                .then((chatRoomContent) => {
                    renderChatContent(chatRoomContent);
                })
        }

        //chatRoomUserの取得
        async function fetchChatUsers() {
            return fetch(`../rooms/1/info`)
                .then((response) => response.json())
                .then((chatRoomUsers) => {
                    renderChatContent(chatRoomUsers);
                })
        }

        //chatContentのpost
        async function postNewChatContent(chatItem) {
            const body = new FormData();
            body.append('content', chatItem.content);
            body.append('postUserName',chatItem.postUserName);

            return fetch(`../rooms/1/add`, {
                method: 'POST',
                body
            })
            .then((response) => response.json());
        }

        //postの処理
        const newChatItemContentInput = document.querySelector('#new-post-content');
        const newChatSubmitButton = document.querySelector('#new-post-content-submit');

        newChatSubmitButton.addEventListener('click', (event) => {
            const content = newChatItemContentInput.value;

            if(content) {
                postNewChatContent({content}).then((item) => fetchChatContent());
            }
        });


        //delete-buttonの取得
        const deleteUserButton = document.querySelector('#delete-user');
        deleteUserButton.addEventListener('click', deleteUser);

        //delete-userの処理
        function deleteUser(event) {

            fetch(`../rooms/1/info`, {method: 'DELETE'})
                .then(() => fetchChatUsers())
                .then(() => location.href='/')
                .then(console.log('deleted user')
                )
        }

        //初回のchatcontentの読み込み
        fetchChatContent();
        fetchChatRoomInfo();
    </script>
</body>
</html>