<!DOCTYPE html>
<html lang="js">
<head>
    <meta charset="UTF-8">
    <title>chatroom</title>
</head>
<body>
    <h1>welcome to Chatroom</h1>
    <p id='online-user'>現在の参加数：</p>
    <p id="roomDiscription">部屋の説明：</p>
    <div>
        <div id="post-content-lists"></div>    
    </div>
        <input type="text" id="new-post-content"><button id="new-post-content-submit">送信</button>

    <div>
        <button id="delete-user">退会する</button>
    </div>

    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect();

        document.querySelector('#new-post-content-submit').addEventListener('click',(e) => {

            const msg = document.querySelector('#new-post-content').value;
            if( msg === ''){
                return(false);
            }

            //socketサーバへ送信
            socket.emit('message', {text: msg});

            msg.value = '';
        });

        socket.on('message-post', (msg) => {
            const list = document.querySelector('#post-content-lists');
            const p = document.createElement('p');
            p.innerHTML = `${msg.text}`;
            list.appendChild(p);
        });


        //Idの取得
        const Id = location.href.slice(28);

        //chatContentの表示
        function renderChatContent(chatRoomContent) {
            const chatContainer = document.querySelector('#post-content-lists');

            chatContainer.innerHTML = '';

            //投稿内容のjsonの取り出し
            for(const message of chatRoomContent) {
                const p = document.createElement('p');
                const label = document.createElement('label');
                const text = new Text(message.content);

                label.appendChild(text);
                p.appendChild(label);
                chatContainer.appendChild(p);
            }

        }

        //chatRoomContentの取得
        async function fetchChatContent() {
            return fetch(`../rooms/${Id}/info`)
                .then((response) => response.json())
                .then((chatRoomContent) => {
                    renderChatContent(chatRoomContent);
                })
        }

        //chatRoomUserの取得
        async function fetchChatUsers() {
            return fetch(`../rooms/${Id}/info`)
                .then((response) => response.json())
                .then((chatRoomUsers) => {
                    renderChatContent(chatRoomUsers);
                })
        }

        //chatContentのpost
        async function postNewChatContent(chatItem) {
            const body = new FormData();
            body.append('content', chatItem.content);
            body.append('postUserName',chatItem.postUserName);

            return fetch(`../rooms/${Id}/add`, {
                method: 'POST',
                body
            })
            .then((response) => response.json());
        }

        //postの処理
        const newChatItemContentInput = document.querySelector('#new-post-content');
        const newChatSubmitButton = document.querySelector('#new-post-content-submit');

        newChatSubmitButton.addEventListener('click', (event) => {
            const content = newChatItemContentInput.value;

            if(content) {
                postNewChatContent({content}).then((item) => fetchChatContent());
            }
        });


        //delete-buttonの取得
        const deleteUserButton = document.querySelector('#delete-user');
        deleteUserButton.addEventListener('click', deleteUser);

        //delete-userの処理
        function deleteUser(event) {

            fetch(`../rooms/${Id}/info`, {method: 'DELETE'})
                .then(() => fetchChatUsers())
                .then(() => location.href='/')
        }

        //オンラインユーザの取得
        async function onlineUser() {
            const onlineUser = document.querySelector('#online-user');

        }   

        //初回のchatcontentの読み込み
        fetchChatContent();
    </script>
</body>
</html>